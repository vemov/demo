<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MP4 å…ƒæ•°æ®ç¼–è¾‘å™¨ (FFmpeg.wasm)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.8/dist/ffmpeg.min.js"></script>

    <style>
        /* ä¿æŒç”¨æˆ·æä¾›çš„æ‰€æœ‰ CSS æ ·å¼ */
        body {    
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;    
            background: #f7f9fc;     
            padding: 20px;    
            display: flex;    
            justify-content: center;    
            align-items: flex-start;     
            min-height: 100vh;
        }
        .container {    
            width: 100%;    
            max-width: 480px;    
            background: #ffffff;    
            padding: 30px;    
            border-radius: 16px;     
            box-shadow: 0 15px 40px rgba(0,0,0,0.08);     
            border: 1px solid #eef1f5; 
        }
        h2 {    
            margin-top: 0;    
            margin-bottom: 25px;    
            text-align: center;    
            color: #333;    
            font-weight: 700;
        }
        label {    
            display: block;    
            margin-top: 18px;    
            margin-bottom: 4px;    
            font-weight: 600;    
            color: #555;    
            font-size: 0.95em;
        }
        input[type="text"] {     
            width: 100%;    
            padding: 12px 15px;    
            margin-top: 4px;    
            box-sizing: border-box;    
            border: 1px solid #dcdfe6;    
            border-radius: 8px;     
            transition: border-color 0.3s, box-shadow 0.3s;    
            font-size: 1em;    
            color: #333;    
            background-color: #fff;
        }
        input[type="text"]:focus {    
            border-color: #4a90e2;    
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.15);     
            outline: none;
        }
        #fileInput, #coverInput {    
            position: absolute;    
            width: 1px;    
            height: 1px;    
            padding: 0;    
            margin: -1px;    
            overflow: hidden;    
            clip: rect(0, 0, 0, 0);    
            border: 0;
        }
        .file-input-wrapper {    
            margin-top: 4px;    
            display: flex;    
            align-items: center;
        }
        .custom-file-upload {    
            background-color: #4a90e2;     
            color: white;    
            padding: 10px 15px;    
            border-radius: 8px;    
            cursor: pointer;    
            font-size: 0.9em;    
            font-weight: 500;    
            transition: background-color 0.3s;    
            flex-shrink: 0;
        }
        .custom-file-upload:hover {    
            background-color: #3a7bd2;
        }
        #fileInput-filename, #coverInput-filename {    
            margin-left: 10px;    
            color: #666;    
            font-size: 0.9em;    
            white-space: nowrap;    
            overflow: hidden;    
            text-overflow: ellipsis;
        }
        #coverPreview {    
            display: block;    
            width: 100px;     
            height: 100px;    
            object-fit: cover;    
            margin: 15px auto 0 auto;     
            border-radius: 10px;    
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);    
            border: 1px solid #eee;
        }
        button {    
            margin-top: 30px;    
            width: 100%;    
            padding: 14px;    
            border: none;    
            background: #4a72d8;    
            color: white;    
            font-size: 18px;    
            font-weight: 600;    
            border-radius: 10px;    
            cursor: pointer;    
            transition: background 0.3s, transform 0.1s;    
            box-shadow: 0 5px 15px rgba(61, 0, 184, 0.3);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #readStatus {
            margin-top: 15px; 
            padding: 8px; 
            border-radius: 5px; 
            text-align: center; 
            font-size: 0.9em;
        }
        .status-loading { background-color: #fff3cd; color: #856404; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .small-text { font-size: 0.8em; color: #666; margin-top: 5px;}
    </style>
</head>
<body>
<div class="container">    
    <h2>MP4 å…ƒæ•°æ®ç¼–è¾‘å™¨</h2>        
    
    <div id="readStatus" class="status-loading">æ­£åœ¨åˆå§‹åŒ– FFmpeg æ ¸å¿ƒ...</div>
    <div class="small-text">å¿…é¡»åœ¨æ”¯æŒ **Cross-Origin Isolation** çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚</div>

    <label for="fileInput">é€‰æ‹© MP4 æ–‡ä»¶</label>    
    <div class="file-input-wrapper">        
        <label for="fileInput" class="custom-file-upload">            
            æµè§ˆæ–‡ä»¶...        
        </label>        
        <span id="fileInput-filename">æœªé€‰æ‹©æ–‡ä»¶</span>    
    </div>    
    <input type="file" id="fileInput" accept="video/mp4, video/m4v" disabled>        

    <label for="title">æ ‡é¢˜</label>    
    <input type="text" id="title" placeholder="å½±ç‰‡æ ‡é¢˜">

    <label for="artist">å‚ä¸åˆ›ä½œçš„è‰ºæœ¯å®¶</label>    
    <input type="text" id="artist" placeholder="ä½œè€…/å¯¼æ¼”">

    <label for="album">ä¸“è¾‘ / èŠ‚ç›®åç§°</label>    
    <input type="text" id="album" placeholder="æ‰€å±ä¸“è¾‘æˆ–ç³»åˆ—">

    <label for="year">å¹´ä»½</label>    
    <input type="text" id="year" placeholder="å‘è¡Œå¹´ä»½">
    
    <label for="genre">æµæ´¾</label>
    <input type="text" id="genre" placeholder="å¦‚: ç§‘å¹», Vlog">
    
    <label for="director">å¯¼æ¼”</label>
    <input type="text" id="director" placeholder="å½±ç‰‡å¯¼æ¼”">
    
    <label for="copyright">ç‰ˆæƒä¿¡æ¯</label>
    <input type="text" id="copyright" placeholder="ç‰ˆæƒä¿¡æ¯">

    <img id="coverPreview" style="display:none;" alt="å°é¢é¢„è§ˆ">
    
    <button id="saveBtn" disabled>ä¿å­˜å¹¶ä¸‹è½½æ–°çš„ MP4 æ–‡ä»¶</button>
</div>

<script>
    // ç¡®ä¿ FFmpeg åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨ (æ¥è‡ª <script src="..."> åŠ è½½)
    if (typeof FFmpeg === 'undefined') {
        alert("é”™è¯¯ï¼šFFmpeg åº“æœªåŠ è½½ã€‚è¯·æ£€æŸ¥ CDN é“¾æ¥å’Œç½‘ç»œè¿æ¥ã€‚");
    }

    const { createFFmpeg, fetchFile } = FFmpeg;

    const ffmpeg = createFFmpeg({ 
        log: true, 
    });

    let uploadedFile = null;
    let isFFmpegLoaded = false;

    const fileInput = document.getElementById('fileInput');
    const fileInputFilename = document.getElementById('fileInput-filename');
    const saveBtn = document.getElementById('saveBtn');
    const readStatus = document.getElementById('readStatus');
    const coverPreview = document.getElementById('coverPreview');

    // æ˜ å°„ FFmpeg æ ‡ç­¾é”®åˆ°è¾“å…¥å…ƒç´ 
    const TAG_ELEMENT_MAP = {
        'title': document.getElementById('title'),
        'artist': document.getElementById('artist'),
        'album': document.getElementById('album'),
        'year': document.getElementById('year'),
        'genre': document.getElementById('genre'),
        'director': document.getElementById('director'),
        'copyright': document.getElementById('copyright'),
    };

    /**
     * æ¸…ç©ºæ‰€æœ‰è¡¨å•å­—æ®µ
     */
    const clearForm = () => {
        Object.values(TAG_ELEMENT_MAP).forEach(input => input.value = '');
        coverPreview.style.display = 'none';
        coverPreview.src = '';
    };

    // 1. FFmpeg æ ¸å¿ƒåŠ è½½å‡½æ•°
    async function loadFFmpeg() {
        if (!isFFmpegLoaded) {
            try {
                await ffmpeg.load();
                isFFmpegLoaded = true;
                readStatus.className = 'status-success';
                readStatus.innerHTML = 'âœ… FFmpeg æ ¸å¿ƒåŠ è½½æˆåŠŸã€‚è¯·ä¸Šä¼ æ–‡ä»¶ã€‚';
                fileInput.disabled = false;
            } catch (e) {
                readStatus.className = 'status-error';
                readStatus.innerHTML = `âŒ FFmpeg åŠ è½½å¤±è´¥ï¼è¯·åœ¨æ”¯æŒ CORS çš„æœåŠ¡å™¨ä¸Šè¿è¡Œã€‚é”™è¯¯: ${e.message}`;
                console.error('FFmpeg åŠ è½½å¤±è´¥:', e);
            }
        }
    }
    loadFFmpeg();

    // 2. æ–‡ä»¶ä¸Šä¼ ä¸å…ƒæ•°æ®è¯»å–
    fileInput.addEventListener('change', () => {
        uploadedFile = fileInput.files[0];
        if (!uploadedFile) return;

        fileInputFilename.textContent = uploadedFile.name;
        saveBtn.disabled = true; // ä¸Šä¼ åå…ˆç¦ç”¨ï¼Œç›´åˆ°è¯»å–å®Œæˆ
        readStatus.className = '';
        readStatus.innerHTML = 'æ­£åœ¨è¯»å–ç°æœ‰å…ƒæ•°æ®...';
        clearForm();
        
        jsmediatags.read(uploadedFile, {
            onSuccess: tag => {
                readStatus.className = '';
                readStatus.innerHTML = `ğŸ“˜ æˆåŠŸè¯»å–ç°æœ‰å…ƒæ•°æ®ã€‚è¯·ä¿®æ”¹åç‚¹å‡»ä¿å­˜ã€‚`;
                saveBtn.disabled = false;
                
                const t = tag.tags;
                
                // å¡«å……è¡¨å•
                for (const key in TAG_ELEMENT_MAP) {
                    if (t[key]) {
                        TAG_ELEMENT_MAP[key].value = t[key];
                    }
                }
                
                // å°é¢å¤„ç† (ä»…è¯»å–å’Œå±•ç¤º)
                if (t.picture) {
                    const picture = t.picture;
                    let base64String = "";
                    for (let i = 0; i < picture.data.length; i++) {                        
                        base64String += String.fromCharCode(picture.data[i]);                    
                    }                    
                    coverPreview.src = "data:" + picture.format + ";base64," + btoa(base64String);                        
                    coverPreview.style.display = 'block';                        
                }
            },            
            onError: err => {                
                readStatus.className = 'status-loading';
                readStatus.innerHTML = 'âš ï¸ æœªæ£€æµ‹åˆ°æ ‡å‡†å…ƒæ•°æ®ï¼Œè¯·æ‰‹åŠ¨å¡«å†™ã€‚';
                saveBtn.disabled = false; // å…è®¸ç”¨æˆ·å¡«å†™åä¿å­˜
            }        
        });
    });

    // 3. ä¿å­˜å’Œå†™å…¥å…ƒæ•°æ®
    saveBtn.addEventListener('click', async () => {
        if (!uploadedFile || !isFFmpegLoaded) {
            alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶å¹¶ç­‰å¾… FFmpeg åŠ è½½å®Œæˆã€‚');
            return;
        }

        saveBtn.disabled = true;
        readStatus.className = 'status-loading';
        readStatus.innerHTML = 'ğŸš€ æ­£åœ¨å†™å…¥å…ƒæ•°æ®å¹¶ç”Ÿæˆæ–°æ–‡ä»¶ (æ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)...';

        const IN_FILE_NAME = 'input.mp4';
        const OUT_FILE_NAME = 'output_edited.mp4';
        const metadataArgs = [];

        // æ„é€  FFmpeg å…ƒæ•°æ®å‚æ•°
        for (const key in TAG_ELEMENT_MAP) {
            const value = TAG_ELEMENT_MAP[key].value.trim();
            if (value) {
                // FFmpeg ä½¿ç”¨ -metadata key="value" æ ¼å¼
                metadataArgs.push('-metadata', `${key}=${value}`);
            }
        }
        
        // æ ¸å¿ƒå‘½ä»¤ç»“æ„: -i è¾“å…¥ -c copy -metadata key=value è¾“å‡ºæ–‡ä»¶
        const command = [
            '-i', IN_FILE_NAME,
            '-c', 'copy', // å¤åˆ¶è§†é¢‘å’ŒéŸ³é¢‘æµï¼Œé¿å…è€—æ—¶çš„é‡æ–°ç¼–ç 
            ...metadataArgs, // æ’å…¥æ‰€æœ‰å…ƒæ•°æ®å‚æ•°
            OUT_FILE_NAME
        ];

        try {
            // å†™å…¥æ–‡ä»¶åˆ° FFmpeg çš„å†…å­˜æ–‡ä»¶ç³»ç»Ÿ (MEMFS)
            ffmpeg.FS('writeFile', IN_FILE_NAME, await fetchFile(uploadedFile));

            // æ‰§è¡Œ FFmpeg å‘½ä»¤
            await ffmpeg.run(...command);
            
            // è¯»å–è¾“å‡ºæ–‡ä»¶
            const data = ffmpeg.FS('readFile', OUT_FILE_NAME);

            // åˆ›å»º Blob URL å¹¶è§¦å‘ä¸‹è½½
            const blob = new Blob([data.buffer], { type: 'video/mp4' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            
            // æ„é€ ä¸‹è½½æ–‡ä»¶å
            const editedTitle = TAG_ELEMENT_MAP.title.value || 'edited';
            const filename = `${editedTitle.replace(/[^a-z0-9]/gi, '_')}.mp4`;
            a.download = filename;
            
            a.click();
            
            URL.revokeObjectURL(url);

            readStatus.className = 'status-success';
            readStatus.innerHTML = 'âœ… å†™å…¥å®Œæˆï¼æ–°æ–‡ä»¶å·²ä¸‹è½½ã€‚';

        } catch (error) {
            readStatus.className = 'status-error';
            readStatus.innerHTML = `âŒ å†™å…¥å¤±è´¥: ${error.message}`;
            console.error('FFmpeg å†™å…¥å…ƒæ•°æ®é”™è¯¯:', error);
        } finally {
            saveBtn.disabled = false;
            // æ¸…ç†å†…å­˜æ–‡ä»¶ç³»ç»Ÿ
            try {
                ffmpeg.FS('unlink', IN_FILE_NAME);
                ffmpeg.FS('unlink', OUT_FILE_NAME);
            } catch (e) {
                 console.warn("æ¸…ç†å†…å­˜æ–‡ä»¶å¤±è´¥:", e);
            }
        }
    });

</script>
</body>
</html>